import { useEffect, useState } from 'react';
const fetchTodaysSchedules = async () => {
    try {
        setLoading(true);
        const response = await axios.get(`${API}/activities/today`);
        setSchedules(response.data);
    } catch (error) {
        console.error('Failed to fetch schedules:', error);
        toast.error('Failed to load today\'s schedules');
    } finally {
        setLoading(false);
    }
};

const handleSelectSchedule = (scheduleId) => {
    setSelectedSchedules(prev => {
        if (prev.includes(scheduleId)) {
            return prev.filter(id => id !== scheduleId);
        } else {
            return [...prev, scheduleId];
        }
    });
};

const handleSelectAll = () => {
    if (selectedSchedules.length === schedules.length) {
        setSelectedSchedules([]);
    } else {
        setSelectedSchedules(schedules.map(s => s.id));
    }
};

const submitActivity = async (actionType, additionalData = {}) => {
    if (selectedSchedules.length === 0) {
        toast.error('Please select at least one schedule');
        return;
    }

    try {
        setLoading(true);

        // Submit activity for each selected schedule
        const promises = selectedSchedules.map(scheduleId =>
            axios.post(`${API}/activities`, {
                schedule_id: scheduleId,
                action_type: actionType,
                ...additionalData
            })
        );

        await Promise.all(promises);

        toast.success(`Activity recorded successfully for ${selectedSchedules.length} schedule(s)`);

        // Reset state
        setSelectedSchedules([]);
        setNotes('');
        setReason('');

        // Close modals
        setStartModalOpen(false);
        setFinishModalOpen(false);
        setHoldModalOpen(false);
        setCancelModalOpen(false);

        // Refresh schedules
        fetchTodaysSchedules();
    } catch (error) {
        toast.error(error.response?.data?.detail || 'Failed to record activity');
    } finally {
        setLoading(false);
    }
};

const handleStart = async () => {
    await submitActivity('start', { notes });
};

const handleFinish = async () => {
    await submitActivity('finish', { notes });
    'On Hold': { color: 'bg-yellow-100 text-yellow-700', icon: Pause }
};

const config = statusConfig[status] || statusConfig['Pending'];
const Icon = config.icon;

return (
    <Badge className={`${config.color} flex items-center space-x-1`}>
        <Icon size={12} />
        <span>{status}</span>
    </Badge>
);
};

return (
    <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div>
                <h1 className="text-4xl font-bold text-slate-800 mb-2 flex items-center space-x-3">
                    <ClipboardCheck className="text-blue-600" size={36} />
                    <span>Today's Activities</span>
                </h1>
                <p className="text-slate-600">
                    {moment().format('MMMM DD, YYYY')} - Record your daily task execution
                </p>
            </div>
        </div>

        {/* Action Buttons */}
        <div className="bg-white rounded-xl p-6 shadow-lg border">
            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div className="flex items-center space-x-2">
                    <Checkbox
                        checked={selectedSchedules.length === schedules.length && schedules.length > 0}
                        onCheckedChange={handleSelectAll}
                        id="select-all"
                    />
                    <Label htmlFor="select-all" className="text-sm font-semibold cursor-pointer">
                        Select All ({selectedSchedules.length} of {schedules.length} selected)
                    </Label>
                </div>

                <div className="flex flex-wrap gap-2">
                    <Button
                        onClick={() => setStartModalOpen(true)}
                        disabled={selectedSchedules.length === 0 || loading}
                        className="bg-blue-500 hover:bg-blue-600"
                        size="sm"
                    >
                        <Play size={16} className="mr-1" />
                        Start
                    </Button>
                    <Button
                        onClick={() => setFinishModalOpen(true)}
                        disabled={selectedSchedules.length === 0 || loading}
                        className="bg-green-500 hover:bg-green-600"
                        size="sm"
                    >
                        <CheckCircle size={16} className="mr-1" />
                        Finish
                    </Button>
                    <Button
                        onClick={() => setHoldModalOpen(true)}
                        disabled={selectedSchedules.length === 0 || loading}
                        className="bg-yellow-500 hover:bg-yellow-600"
                        size="sm"
                    >
                        <Pause size={16} className="mr-1" />
                        Hold
                    </Button>
                    <Button
                        onClick={() => setCancelModalOpen(true)}
                        disabled={selectedSchedules.length === 0 || loading}
                        variant="destructive"
                        size="sm"
                    >
                        <XCircle size={16} className="mr-1" />
                        Cancel
                    </Button>
                </div>
            </div>
        </div>

        {/* Schedules List */}
        <div className="space-y-4">
            <h2 className="text-xl font-bold text-slate-800">Your Schedules for Today</h2>

            {loading && schedules.length === 0 ? (
                <div className="text-center py-12">
                    <p className="text-slate-500">Loading schedules...</p>
                </div>
            ) : schedules.length === 0 ? (
                <Card>
                    <CardContent className="py-12">
                        <p className="text-center text-slate-500">
                            No schedules assigned for today. Enjoy your day!
                        </p>
                    </CardContent>
                </Card>
            ) : (
                <div className="grid gap-4">
                    {schedules.map(schedule => (
                        <Card
                            key={schedule.id}
                            className={`cursor-pointer transition-all hover:shadow-md ${selectedSchedules.includes(schedule.id) ? 'ring-2 ring-blue-500 bg-blue-50' : ''
                                }`}
                            onClick={() => handleSelectSchedule(schedule.id)}
                        >
                            <CardContent className="p-6">
                                <div className="flex items-start space-x-4">
                                    <Checkbox
                                        checked={selectedSchedules.includes(schedule.id)}
                                        onCheckedChange={() => handleSelectSchedule(schedule.id)}
                                        onClick={(e) => e.stopPropagation()}
                                        className="mt-1"
                                    />

                                    <div className="flex-1 space-y-2">
                                        <div className="flex items-start justify-between">
                                            <h3 className="text-lg font-semibold text-slate-800">
                                                {schedule.title}
                                            </h3>
                                            {getStatusBadge(schedule.activity_status)}
                                        </div>

                                        {schedule.description && (
                                            <p className="text-sm text-slate-600">
                                                {schedule.description}
                                            </p>
                                        )}

                                        <div className="flex flex-wrap gap-4 text-sm text-slate-500">
                                            <div className="flex items-center space-x-1">
                                                <Clock size={14} />
                                                <span>{moment(schedule.start_date).format('HH:mm')}</span>
                                            </div>
                                            <div>
                                                <span className="font-medium">Division:</span> {schedule.division}
                                            </div>
                                        </div>

                                        {schedule.latest_activity && (
                                            <div className="mt-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                <p className="text-xs font-semibold text-slate-600 mb-1">Latest Activity:</p>
                                                <p className="text-xs text-slate-600">
                                                    {schedule.latest_activity.action_type.toUpperCase()} - {moment(schedule.latest_activity.created_at).format('MMM DD, HH:mm')}
                                                </p>
                                                {schedule.latest_activity.notes && (
                                                    <p className="text-xs text-slate-500 mt-1">
                                                        Notes: {schedule.latest_activity.notes}
                                                    </p>
                                                )}
                                                {schedule.latest_activity.reason && (
                                                    <p className="text-xs text-slate-500 mt-1">
                                                        Reason: {schedule.latest_activity.reason}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            )}
        </div>

        {/* Start Modal */}
        <Dialog open={startModalOpen} onOpenChange={setStartModalOpen}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center space-x-2">
                        <Play className="text-blue-600" size={20} />
                        <span>Start Activity</span>
                    </DialogTitle>
                    <DialogDescription>
                        Record the start of {selectedSchedules.length} selected task(s). You can add optional notes.
                    </DialogDescription>
                </DialogHeader>

                <div className="space-y-4">
                    <div>
                        <Label htmlFor="start-notes">Notes (Optional)</Label>
                        <Textarea
                            id="start-notes"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            placeholder="Add any notes about starting this task..."
                            rows={3}
                        />
                    </div>
                </div>

                <DialogFooter>
                    <Button variant="outline" onClick={() => setStartModalOpen(false)}>
                        Cancel
                    </Button>
                    <Button onClick={handleStart} className="bg-blue-500 hover:bg-blue-600" disabled={loading}>
                        Start Activity
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>

        {/* Finish Modal */}
        <Dialog open={finishModalOpen} onOpenChange={setFinishModalOpen}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center space-x-2">
                        <CheckCircle className="text-green-600" size={20} />
                        <span>Finish Activity</span>
                    </DialogTitle>
                    <DialogDescription>
                        Mark {selectedSchedules.length} selected task(s) as finished. You can add completion notes.
                    </DialogDescription>
                </DialogHeader>

                <div className="space-y-4">
                    <div>
                        <Label htmlFor="finish-notes">Notes (Optional)</Label>
                        <Textarea
                            id="finish-notes"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            placeholder="Add any completion notes..."
                            rows={3}
                        />
                    </div>
                </div>

                <DialogFooter>
                    <Button variant="outline" onClick={() => setFinishModalOpen(false)}>
                        Cancel
                    </Button>
                    <Button onClick={handleFinish} className="bg-green-500 hover:bg-green-600" disabled={loading}>
                        Finish Activity
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>

        {/* Hold Modal */}
        <Dialog open={holdModalOpen} onOpenChange={setHoldModalOpen}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center space-x-2">
                        <Pause className="text-yellow-600" size={20} />
                        <span>Put Activity On Hold</span>
                    </DialogTitle>
                    <DialogDescription>
                        Are you sure you want to put {selectedSchedules.length} selected task(s) on hold? Your manager will be notified.
                    </DialogDescription>
                </DialogHeader>

                <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p className="text-sm text-yellow-800">
                        <strong>Note:</strong> Your manager will receive a notification about this task being on hold so they can reschedule if needed.
                    </p>
                </div>

                <DialogFooter>
                    <Button variant="outline" onClick={() => setHoldModalOpen(false)}>
                        Cancel
                    </Button>
                    <Button onClick={handleHold} className="bg-yellow-500 hover:bg-yellow-600" disabled={loading}>
                        Confirm Hold
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>

        {/* Cancel Modal */}
        <Dialog open={cancelModalOpen} onOpenChange={setCancelModalOpen}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center space-x-2">
                        <XCircle className="text-red-600" size={20} />
                        <span>Cancel Activity</span>
                    </DialogTitle>
                    <DialogDescription>
                        Cancel {selectedSchedules.length} selected task(s). You must provide a reason for cancellation.
                    </DialogDescription>
                </DialogHeader>

                <div className="space-y-4">
                    <div>
                        <Label htmlFor="cancel-reason">Reason for Cancellation *</Label>
                        <Textarea
                            id="cancel-reason"
                            value={reason}
                            onChange={(e) => setReason(e.target.value)}
                            placeholder="Explain why you are cancelling this task..."
                            rows={3}
                            required
                        />
                    </div>
                </div>

                <DialogFooter>
                    <Button variant="outline" onClick={() => setCancelModalOpen(false)}>
                        Cancel
                    </Button>
                    <Button onClick={handleCancel} variant="destructive" disabled={loading || !reason.trim()}>
                        Cancel Activity
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    </div>
);
};

export default Activity;
